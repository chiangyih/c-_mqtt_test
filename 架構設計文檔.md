# MQTT 客戶端 - 架構設計文檔

## ??? 整體架構

```
┌─────────────────────────────────────────────────────────────┐
│                        MQTT 客戶端應用                        │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │            用戶界面層 (UI Layer)                     │   │
│  │  ┌────────┐ ┌────────┐ ┌──────────┐ ┌────────┐     │   │
│  │  │連線輸入│ │主題輸入│ │訊息顯示  │ │狀態指示│     │   │
│  │  └────────┘ └────────┘ └──────────┘ └────────┘     │   │
│  └──────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          業務邏輯層 (Business Logic Layer)          │   │
│  │  ┌────────────┐ ┌────────────┐ ┌──────────────────┐ │   │
│  │  │連線管理    │ │主題訂閱    │ │訊息接收處理     │ │   │
│  │  │? Validate  │ │? Validate  │ │? IsSubscribed  │ │   │
│  │  │? Attempt   │ │? Subscribe │ │? Log           │ │   │
│  │  │? Handle    │ │? Notify    │ │? Display       │ │   │
│  │  └────────────┘ └────────────┘ └──────────────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          數據通信層 (Communication Layer)            │   │
│  │              IMqttClient (MQTTnet)                   │   │
│  │  ├─ ConnectAsync()                                  │   │
│  │  ├─ SubscribeAsync()                                │   │
│  │  ├─ DisconnectAsync()                               │   │
│  │  └─ ApplicationMessageReceivedAsync                 │   │
│  └──────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │        外部系統層 (External System Layer)            │   │
│  │              MQTT Broker (遠端)                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## ?? 連線流程圖

```
用戶輸入 IP
    │
    ▼
┌─────────────────────┐
│ Button_connect_Click│
└─────────────────────┘
    │
    ▼
┌──────────────────────────┐
│ ValidateServerInput()    │
│ ? 檢查輸入是否為空       │
└──────────────────────────┘
    │ 驗證通過
    ▼
┌──────────────────────────┐
│ AttemptConnection()      │
│ ? 更新 UI 狀態           │
│ ? 設定連線狀態為「連線中」│
└──────────────────────────┘
    │
    ▼
┌──────────────────────────┐
│ BuildMqttClientOptions() │
│ ? 設定 IP 和 Port       │
│ ? 生成唯一 ClientId     │
└──────────────────────────┘
    │
    ▼
┌──────────────────────────┐
│ mqttClient.ConnectAsync()│
│ (MQTTnet Library)        │
└──────────────────────────┘
    │
    ├─ 成功 ─────────────────────┐
    │                            │
    │                            ▼
    │                 ┌──────────────────────┐
    │                 │OnConnectionSuccess() │
    │                 │? 顯示成功訊息        │
    │                 │? 啟用訂閱按鈕        │
    │                 │? 更新狀態為「已連線」│
    │                 │? 鎖定 IP 輸入       │
    │                 └──────────────────────┘
    │                            │
    │                            ▼
    │                    連線完成 ?
    │
    └─ 失敗 ─────────────────────┐
    │                            │
    │                            ▼
    │                 ┌──────────────────────┐
    │                 │OnConnectionFailed()  │
    │                 │? 顯示失敗原因        │
    │                 │? 恢復連線按鈕        │
    │                 │? 更新狀態為「未連線」│
    │                 └──────────────────────┘
    │                            │
    │                            ▼
    │                    連線失敗 ?
    │
    └─ 異常 ─────────────────────┐
                                 │
                                 ▼
                    ┌──────────────────────┐
                    │HandleConnectionError()
                    │? 顯示異常訊息        │
                    │? 恢復連線按鈕        │
                    │? 更新狀態為「未連線」│
                    └──────────────────────┘
                                 │
                                 ▼
                        連線異常 ?
```

## ?? 訂閱流程圖

```
用戶輸入主題
    │
    ▼
┌──────────────────────┐
│Button_confirm1_Click │
└──────────────────────┘
    │
    ▼
┌──────────────────────┐
│ValidateTopicInput()  │
│? 檢查主題是否為空    │
└──────────────────────┘
    │ 通過
    ▼
┌──────────────────────┐
│ValidateConnection()  │
│? 檢查是否已連線      │
└──────────────────────┘
    │ 通過
    ▼
┌──────────────────────┐
│SubscribeToTopic()    │
│? 構建主題篩選器      │
│? 執行訂閱            │
│? 記錄當前主題        │
└──────────────────────┘
    │
    ▼
┌──────────────────────┐
│LogSubscriptionMsg()  │
│? 在訊息框顯示        │
│  「已訂閱：xxx」      │
└──────────────────────┘
    │
    ▼
┌──────────────────────┐
│NotifySuccess()       │
│? 顯示成功對話框      │
└──────────────────────┘
    │
    ▼
  訂閱完成 ?
  等待訊息...
```

## ?? 訊息接收流程圖

```
MQTT Broker 發送訊息
    │
    ▼
┌──────────────────────────────────────────┐
│MqttClient_AppMessageReceivedAsync()      │
│(由 MQTTnet Library 觸發)                │
└──────────────────────────────────────────┘
    │
    ▼
┌──────────────────────┐
│IsSubscribedTopic()   │
│? 檢查是否為訂閱主題  │
└──────────────────────┘
    │
    ├─ 是訂閱主題 ────────────┐
    │                        │
    │                        ▼
    │            ┌──────────────────────┐
    │            │ Invoke() UI 線程      │
    │            │ ? 確保線程安全       │
    │            └──────────────────────┘
    │                        │
    │                        ▼
    │            ┌──────────────────────┐
    │            │LogReceivedMessage()  │
    │            │? 格式化訊息          │
    │            │? 在 RichTextBox 顯示 │
    │            │? 自動捲動到最新      │
    │            └──────────────────────┘
    │                        │
    │                        ▼
    │              訊息已顯示 ?
    │
    └─ 非訂閱主題 ──┐
                    │
                    ▼
             忽略此訊息 (無操作)
```

## ?? 斷線流程圖

```
用戶點擊斷線
    │
    ▼
┌──────────────────────┐
│Button_disconnect_Click
└──────────────────────┘
    │
    ▼
┌──────────────────────────┐
│ConfirmDisconnection()    │
│? 顯示確認對話框         │
│「確定要斷開連線嗎？」    │
└──────────────────────────┘
    │
    ├─ 用戶確認（是）────────────┐
    │                           │
    │                           ▼
    │            ┌──────────────────────┐
    │            │DisconnectFromBroker()│
    │            │? 執行斷線操作        │
    │            │? 重置連線狀態        │
    │            └──────────────────────┘
    │                           │
    │                           ▼
    │            ┌──────────────────────┐
    │            │OnDisconnectionSuccess
    │            │? 顯示成功訊息        │
    │            │? 更新狀態為「未連線」│
    │            │? 啟用連線按鈕        │
    │            │? 解鎖 IP 輸入       │
    │            └──────────────────────┘
    │                           │
    │                           ▼
    │                  斷線完成 ?
    │
    └─ 用戶取消（否）─────────────┐
                                 │
                                 ▼
                    保持連線狀態，無操作
```

## ??? 代碼結構樹

```
Form1.cs (主表單類別)
│
├─ [欄位]
│  ├─ mqttClient              (MQTT 客戶端實例)
│  └─ currentSubscribedTopic   (當前訂閱主題)
│
├─ [初始化區域]
│  ├─ Form1()                            (構造函數)
│  ├─ InitializeEventHandlers()         (事件綁定)
│  ├─ InitializeMqtt()                  (MQTT 初始化)
│  └─ InitializeButtonStates()          (按鈕初始狀態)
│
├─ [連線管理區域]
│  ├─ UpdateConnectionStatus()          (更新狀態顯示)
│  ├─ Button_connect_Click()            (連線事件)
│  ├─ ValidateServerInput()             (輸入驗證)
│  ├─ AttemptConnection()               (嘗試連線)
│  ├─ BuildMqttClientOptions()          (構建選項)
│  ├─ OnConnectionSuccess()             (成功處理)
│  ├─ OnConnectionFailed()              (失敗處理)
│  └─ HandleConnectionError()           (異常處理)
│
├─ [斷線管理區域]
│  ├─ Button_disconnect_Click()         (斷線事件)
│  ├─ ConfirmDisconnection()            (確認對話框)
│  ├─ DisconnectFromBroker()            (執行斷線)
│  ├─ ResetConnectionState()            (重置狀態)
│  ├─ OnDisconnectionSuccess()          (成功處理)
│  └─ HandleDisconnectionError()        (異常處理)
│
├─ [主題訂閱區域]
│  ├─ Button_confirm1_Click()           (訂閱事件)
│  ├─ ValidateTopicInput()              (主題驗證)
│  ├─ ValidateConnection()              (連線檢查)
│  ├─ SubscribeToTopic()                (執行訂閱)
│  ├─ LogSubscriptionMessage()          (記錄訂閱)
│  ├─ NotifySubscriptionSuccess()       (成功通知)
│  └─ HandleSubscriptionError()         (異常處理)
│
├─ [訊息接收區域]
│  ├─ MqttClient_ApplicationMessageReceivedAsync() (訊息事件)
│  ├─ IsSubscribedTopic()               (主題檢查)
│  ├─ LogReceivedMessage()              (記錄訊息)
│  └─ HandleMessageReceiveError()       (異常處理)
│
├─ [UI 輔助方法區域]
│  └─ AppendText()                      (追加文字)
│
└─ [程式結束區域]
   ├─ Button_exit_Click()               (退出事件)
   ├─ Form1_FormClosing()               (關閉事件)
   └─ CleanupResources()                (資源清理)
```

## ?? 數據流向圖

```
┌────────────────────────────────────────────────────────────┐
│                     用戶輸入                                 │
│  ┌──────────┬──────────┬──────────┬──────────┐            │
│  │Server IP │主題名稱  │連線按鈕  │訂閱按鈕  │            │
│  └──────────┴──────────┴──────────┴──────────┘            │
└────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────────────┐
│                   驗證層                                    │
│  ┌──────────────────────┬──────────────────────┐          │
│  │ValidateServerInput() │ValidateTopicInput()  │          │
│  │ValidateConnection()  │                      │          │
│  └──────────────────────┴──────────────────────┘          │
└────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────────────┐
│                   邏輯層                                    │
│  ┌──────────────────────┬──────────────────────┐          │
│  │AttemptConnection()   │SubscribeToTopic()    │          │
│  │BuildMqttOptions()    │                      │          │
│  └──────────────────────┴──────────────────────┘          │
└────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────────────┐
│               通信層 (MQTTnet)                              │
│  ┌──────────────────────┬──────────────────────┐          │
│  │ConnectAsync()        │SubscribeAsync()      │          │
│  │DisconnectAsync()     │                      │          │
│  └──────────────────────┴──────────────────────┘          │
└────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────────────┐
│              遠端 MQTT Broker                              │
│  ├─ 連線管理                                              │
│  ├─ 主題管理                                              │
│  ├─ 訊息儲存和轉發                                         │
│  └─ 用戶認證                                              │
└────────────────────────────────────────────────────────────┘
                        │
                        ▼ (訊息回傳)
┌────────────────────────────────────────────────────────────┐
│               通信層 (MQTTnet)                              │
│  └─ ApplicationMessageReceivedAsync 事件                    │
└────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────────────┐
│                   邏輯層                                    │
│  ├─ IsSubscribedTopic()                                   │
│  ├─ LogReceivedMessage()                                  │
│  └─ AppendText()                                          │
└────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────────────┐
│                   UI 更新                                  │
│  ┌──────────────┬──────────────┬──────────────┐          │
│  │RichTextBox   │狀態指示器    │按鈕狀態      │          │
│  │(訊息顯示)    │(連線狀態)    │(可用性控制)  │          │
│  └──────────────┴──────────────┴──────────────┘          │
└────────────────────────────────────────────────────────────┘
```

## ?? 狀態轉遷圖

```
                    ┌─────────────┐
                    │   初始狀態   │
                    │ (未連線)    │
                    └──────┬──────┘
                           │
                           │ Button_connect_Click
                           ▼
                    ┌─────────────────┐
                    │   連線狀態      │
                    │ (連線中...)    │
                    └──────┬──────────┘
                           │
              ┌────────────┴────────────┐
              │                         │
              ▼ (成功)                  ▼ (失敗/異常)
        ┌──────────────┐          ┌──────────────┐
        │ 已連線狀態   │          │  未連線狀態  │
        │ (可訂閱)     │          │  (重新嘗試)  │
        └──────┬───────┘          └──────────────┘
               │
               │ Button_confirm1_Click
               ▼
        ┌──────────────┐
        │ 已訂閱狀態   │
        │ (接收訊息)   │
        └──────┬───────┘
               │
               │ Button_disconnect_Click
               ▼
        ┌──────────────────┐
        │ 確認斷線狀態    │
        └──────┬───────────┘
               │
               │ 確認
               ▼
        ┌──────────────┐
        │  未連線狀態  │
        │ (初始化)     │
        └──────────────┘
```

---

**版本：** 2.0  
**更新日期：** 2024 年  
**狀態：** ? 完成
